= Cloudbees action: Scan with Perforce Klocwork SAST

Use this action to scan repositories for security vulnerabilities, quality defects, and compliance issues with the Perforce Klocwork Static Application Security Testing (SAST) scanner.
You can also use the action output as a quality gate for the next step or job in your workflow.

Klocwork is a static application security testing (SAST) solution that helps organizations identify security, quality, and compliance issues in their source code through deep static analysis.

Add a Klocwork scan to your workflows in CloudBees platform to:

* Detect security vulnerabilities, quality defects, and compliance issues in source code.
* Identify potential security flaws early in the development lifecycle.
* Gain insight into code quality risks and how to fix issues.
* Ensure compliance with industry standards such as OWASP, CWE, CERT, and MISRA.

CloudBees platform enables you to run a Klocwork scan either implicitly or explicitly.

== Explicit and implicit scan types

An implicit scan is automatically triggered, and an explicit scan is one you configure to be invoked in a step of your workflow.
To learn more about the differences between explicit and implicit scans, refer to link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/actions#security[Security scan actions].

To set up implicit scanning, refer to link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/aspm/implicit-security-analysis[Code and binary security analysis].

== Scanner information

The Klocwork SAST scanner architectural components are:

* Client-side: The Klocwork analysis engine and command-line tools (kwcheck, kwbuildproject, kwciagent).
* Server-side: The Klocwork Server for centralized analysis results management.
* Analysis engine: Proprietary static analysis engine with deep dataflow and control flow analysis capabilities.

The scanning process is as follows:

. The Klocwork build specification is created to capture the build configuration of your project.
. Source code is analyzed on the client side using the Klocwork analysis engine.
. The analysis results are uploaded to the Klocwork Server (if configured).
. Security vulnerabilities, quality defects, and compliance violations are identified based on enabled checkers and taxonomies.
. Results are reported with severity levels, detailed descriptions, and remediation guidance.
. The scan results are made available as actionable outputs for quality gates and downstream workflow steps.

NOTE: For more information about the Perforce Klocwork SAST scanner, refer to the link:https://www.perforce.com/products/klocwork[Perforce Klocwork documentation].

== Inputs

[cols="2a,1a,1a,3a",options="header"]
.Input details
|===

| Input name
| Data type
| Required?
| Description

| `enableAgentScan`
| Boolean
| No
| Enable Klocwork Agent Scan defaulted to false.

| `url`
| String
| Yes
| The Klocwork server URL.

| `licenseHost`
| String
| No
| Klocwork license server hostname.

| `licensePort`
| String
| No
| Klocwork license server port.

| `username`
| String
| Yes
| Klocwork username.

| `token`
| String
| No
| Klocwork application token.

| `password`
| String
| No
| Klocwork password.

| `projectName`
| String
| No
| Klocwork project name.

| `buildName`
| String
| No
| Klocwork build name.

| `buildDirectory`
| String
| Yes
| Klocwork build directory.

| `buildTool`
| String
| Yes
| Klocwork build tool [make/cmake/python/maven/gradle/gradlew/dotnet].

| `buildSpecFile`
| String
| No
| Klocwork build specification file path [e:g: /tmp/kwinject.out].

| `tablesDirectory`
| String
| No
| Klocwork scan tables directory [e:g: /tmp/tables].

| `buildOptions`
| String
| No
| Klocwork scan build options [e:g: make -j4].

| `scanTimeOut`
| String
| No
| Klocwork scan waiting time in seconds [e:g: 3600].

| `ref`
| String
| Yes
| Specify the ref to be checked out and scanned.

| `workspace-dir`
| String
| No
| The file path of the code to be scanned.

|===

== Outputs

[cols="2a,1a,4a",options="header"]
.Output details
|===

| Output name
| Data type
| Description

| `critical-count`
| String
| The number of *Critical* severity issues discovered during the scan.

| `high-count`
| String
| The number of *High* severity issues discovered during the scan.

| `medium-count`
| String
| The number of *Medium* severity issues discovered during the scan.

| `low-count`
| String
| The number of *Low* severity issues discovered during the scan.

| `total-issues`
| String
| The total number of issues discovered during the scan.

|===

== Usage examples

=== Basic usage

The following is a basic usage example for this action:

[source,yaml]
----

      - name: Scan with Klocwork SAST
        uses: cloudbees-io/perforce-klocwork-sast-plugin-private@v1
        with:
          url: ${{ vars.KLOCWORK_URL }}
          token: ${{ secrets.KLOCWORK_APP_TOKEN }}
          username:  ${{ vars.KLOCWORK_USERNAME }}
          buildDirectory:  ${{ vars.KLOCWORK_BUILD_DIR }}
          buildTool:  ${{ vars.KLOCWORK_BUILD_TOOL }}
          ref: main

----

=== Using project-specific configuration

In the following example, a specific project name and build specification are provided:

[source,yaml]
----

      - name: Scan with Klocwork SAST with custom config
        uses: cloudbees-io/perforce-klocwork-sast-plugin-private@v1
        with:
          url: ${{ vars.KLOCWORK_URL }}
          token: ${{ secrets.KLOCWORK_APP_TOKEN }}
          username:  ${{ vars.KLOCWORK_USERNAME }}
          ref: main
          projectName: 'my-security-critical-project'
          buildSpec:  '/tmp/kwinject.out'
          buildDirectory:  ${{ vars.KLOCWORK_BUILD_DIR }}
          buildTool:  ${{ vars.KLOCWORK_BUILD_TOOL }}

----

=== Scan a Java application with Klocwork

The following CloudBees platform workflow example scans a Java application with Klocwork.

[source, yaml,role="default-expanded"]
----

name: klocwork-sast-scan
kind: workflow
apiVersion: automation.cloudbees.io/v1alpha1

on:
  push:
    branches:
      - main

permissions:
  scm-token-own: read
  scm-token-org: read
  id-token: write

jobs:
  klocwork-scan:
    steps:
      - name: Check out Java source code
        uses: cloudbees-io/checkout@v1

      - name: Set up JDK
        uses: docker://maven:3.8-openjdk-11
        run: |
          mvn clean compile

      - name: Klocwork SAST scan on Java code
        uses: cloudbees-io/perforce-klocwork-sast-plugin-private@v1
        with:
          url: ${{ vars.KLOCWORK_URL }}
          token: ${{ secrets.KLOCWORK_APP_TOKEN }}
          username:  ${{ vars.KLOCWORK_USERNAME }}
          projectName: 'my-java-project'
          buildTool: 'maven'
          buildDirectory: '/'
          ref: main

----

=== Scan a C language repository with Perforce Klocwork SAST scanner

The following CloudBees platform workflow example scans a C++ repository with Perforce Klocwork SAST.

[source, yaml,role="default-expanded"]
----

name: klocwork-sast-scan
kind: workflow
apiVersion: automation.cloudbees.io/v1alpha1

on:
  push:
    branches:
      - main

permissions:
  scm-token-own: read
  scm-token-org: read
  id-token: write

jobs:
  klocwork-scan:
    steps:
      - name: Check out C++ source code
        uses: cloudbees-io/checkout@v1

      - name: Perforce Klocwork scan on C++ code
        uses: cloudbees-io/perforce-klocwork-sast-plugin-private@v2
        with:
          url: ${{ vars.KLOCWORK_URL }}
          token: ${{ secrets.KLOCWORK_APP_TOKEN }}
          username:  ${{ vars.KLOCWORK_USERNAME }}
          projectName: 'my-java-project'
          buildTool: 'make'
          buildDirectory: '/'
          buildOps: 'make all --ignore-errors -j14'

----

====

=== Using the action output

Access the output values in downstream steps and jobs using the `outputs` link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/dsl-syntax/contexts[context].

Use the output in your workflow as follows, where <action_step_ID> is the action step ID, and <severity> is an output parameter name, such as `critical-count`:

[source,yaml]
----
${{steps.<action_step_ID>.outputs.<severity>}}
----

The following example uses the action output in a downstream step of the same job:

[source,yaml,role="default-expanded"]
----

name: my-workflow
kind: workflow
apiVersion: automation.cloudbees.io/v1alpha1

on:
  push:
    branches:
      - main

permissions:
  scm-token-own: read
  scm-token-org: read
  id-token: write

jobs:
  klocwork-scan-job:
    steps:
      - name: check out source code
        uses: cloudbees-io/checkout@v1

      - id: klocwork-step
        name: perforce klocwork scan
        uses: cloudbees-io/perfornce-klocwork-sast-plugin-private@v1

      - name: source dir examine
        uses: docker://golang:1.20.3-alpine3.17
        shell: sh
        run: |
          ls -latR /cloudbees/workspace

      - id: print-outputs-from-klocwork-step
        name: print outputs from upstream klocwork step
        uses: docker://alpine:latest
        run: |
            #printing all outputs
            echo "Outputs from upstream klocwork step:"
            echo "Critical count: ${{steps.klocwork-step.outputs.critical-count}}"
            echo "Very high count: ${{steps.klocwork-step.outputs.very-high-count}}"
            echo "High count: ${{steps.klocwork-step.outputs.high-count}}"
            echo "Medium count: ${{steps.klocwork-step.outputs.medium-count}}"
            echo "Low count: ${{steps.klocwork-step.outputs.low-count}}"


----

The following example uses the action output in a downstream job:

[source,yaml,role="default-expanded"]
----

name: my-workflow
kind: workflow
apiVersion: automation.cloudbees.io/v1alpha1

on:
  push:
    branches:
      - main

permissions:
  scm-token-own: read
  scm-token-org: read
  id-token: write

jobs:
  job1:
    outputs:
      klocwork-job-output-critical: ${{ steps.klocwork-step.outputs.critical-count }}
      klocwork-job-output-very-high: ${{ steps.klocwork-step.outputs.very-high-count }}
      klocwork-job-output-high: ${{ steps.klocwork-step.outputs.high-count }}
      klocwork-job-output-medium: ${{ steps.klocwork-step.outputs.medium-count }}
      klocwork-job-output-low: ${{ steps.klocwork-step.outputs.low-count }}
    steps:
      - name: check out source code
        uses: cloudbees-io/checkout@v1
        with:
          repository: my-gh-repo-org/my-repo
          ref: main
          token: ${{ secrets.GIT_PAT }}

      - id: klocwork-step
        name: perforce klocwork scan
        uses: cloudbees-io/perforce-klocwork-sast-plugin-private@v1
        with:
          url: ${{ vars.KLOCWORK_URL }}
          token: ${{ secrets.KLOCWORK_APP_TOKEN }}
          username:  ${{ vars.KLOCWORK_USERNAME }}
          projectName: 'my-project'
          buildTool: 'make'
          buildDirectory: '/'
          buildOps: 'make all --ignore-errors -j14'
          ref: main

  job2:
    needs: job1
    steps:
      - id: print-outputs-from-job1
        name: print outputs from upstream job1
        uses: docker://alpine:latest
        run: |
          # Printing all outputs
          echo "Outputs from upstream Klocwork job:"
          echo "Critical count: ${{ needs.job1.outputs.klocwork-job-output-critical }}"
          echo "Very high count: ${{ needs.job1.outputs.klocwork-job-output-very-high }}"
          echo "High count: ${{ needs.job1.outputs.klocwork-job-output-high }}"
          echo "Medium count: ${{ needs.job1.outputs.klocwork-job-output-medium }}"
          echo "Low count: ${{ needs.job1.outputs.klocwork-job-output-low }}"

----

== License

This code is made available under the
link:https://opensource.org/license/mit/[MIT license].

== References

* Learn more about link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/actions[using actions in CloudBees workflows].
* Learn about link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/[CloudBees platform].
